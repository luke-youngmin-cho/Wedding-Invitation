rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 방명록 규칙
    match /guestbook/{document} {
      // 누구나 읽기 가능
      allow read: if true;
      
      // 작성 규칙: 필수 필드 검증
      allow create: if isValidGuestbook(request.resource.data);
      
      // 수정 및 삭제 금지
      allow update, delete: if false;
    }
    
    // 참석 여부 규칙
    match /rsvp/{document} {
      // 읽기 금지 (관리자만 가능하도록)
      allow read: if false;
      
      // 작성 규칙: 필수 필드 검증
      allow create: if isValidRsvp(request.resource.data);
      
      // 중복 방지를 위한 업데이트 허용 (같은 이름)
      allow update: if isValidRsvp(request.resource.data) && 
                      resource.data.name == request.resource.data.name;
      
      // 삭제 금지
      allow delete: if false;
    }
    
    // 게임 점수 규칙 - 검증된 점수만 허용
    match /gameScores/{document} {
      allow read: if true;
      
      // 생성만 허용 (수정/삭제 금지)
      allow create: if isValidGameScore(request.resource.data);
      allow update, delete: if false;
    }
    
    // 관리자 통계 데이터 (읽기 전용)
    match /statistics/{document} {
      allow read: if true;
      allow write: if false;
    }
    
    // 유효성 검증 함수들
    function isValidGuestbook(data) {
      return data.keys().hasAll(['name', 'msg']) &&
             data.name is string &&
             data.name.size() > 0 &&
             data.name.size() <= 50 &&
             data.msg is string &&
             data.msg.size() > 0 &&
             data.msg.size() <= 500;
             // ts는 serverTimestamp()로 자동 설정되므로 검증하지 않음
    }
    
    function isValidRsvp(data) {
      return data.name is string &&
             data.name.size() > 0 &&
             data.name.size() <= 50 &&
             data.phone is string &&
             data.phone.size() >= 0 &&
             data.phone.size() <= 20;
             // phone 필드는 빈 문자열도 허용, 다른 필드는 선택사항으로 처리
    }
    
    function isValidGameScore(data) {
      return data.keys().hasAll(['name', 'score', 'ts']) &&
             data.keys().size() == 3 && // 정확히 3개 필드만 허용
             data.name is string &&
             data.name.size() > 0 &&
             data.name.size() <= 50 &&
             data.score is int &&
             data.score >= 0 &&
             data.score <= 100000000 && // 최대 1억점
             data.score != 2147483647 && // 32-bit 정수 최대값 차단
             data.ts == request.time; // serverTimestamp() 사용 강제
    }
  }
}